import { getAccessTokenAnyway } from '@/auth/lib/jwt';
import Header from '@/common/components/Header';
import { MANITO_GROUP_DETAIL } from '@/manito_group/constant/query_key';
import useManitoGroupDetailQuery from '@/manito_group/hooks/useManitoGroupDetailQuery';
import { fetchGroupDetail } from '@/manito_group/lib/fetch';
import { DehydratedState, QueryClient, dehydrate } from '@tanstack/react-query';
import { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';
import { useRouter } from 'next/router';

const ManitoGroupPage: NextPage = () => {
  const router = useRouter();
  const { data } = useManitoGroupDetailQuery(String(router.query.groupId));
  return (
    <>
      <Head>
        <title>{data?.name} | Manito group page</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <Header />
      <main className='pt-20'>
        <h1>{data?.name}</h1>
      </main>
    </>
  );
};

ManitoGroupPage.getInitialProps = async ({ req, res, asPath }) => {
  const accessToken = await getAccessTokenAnyway({ req, res });

  const queryClient = new QueryClient();
  const groupId = String(asPath?.split('/')[2]);
  await queryClient.prefetchQuery([MANITO_GROUP_DETAIL, groupId], () =>
    fetchGroupDetail(groupId, accessToken)
  );

  return {
    dehydratedState: dehydrate(queryClient),
  };
};

/*
// getServerSideProps를 사용하는 경우 fetch함수에서 Date 객체를 그대로 리턴 불가 - JSON serialize를 해서 리턴해야함

export const getServerSideProps: GetServerSideProps<{ dehydratedState: DehydratedState }> = async ({
  req,
  res,
  params,
}) => {
  const accessToken = await getAccessTokenAnyway({ req, res });

  const queryClient = new QueryClient();
  const groupId = String(params?.groupId);
  await queryClient.prefetchQuery([MANITO_GROUP_DETAIL, groupId], () =>
    fetchGroupDetail(groupId, accessToken)
  );

  return {
    props: { dehydratedState: dehydrate(queryClient) },
  };
};

*/

export default ManitoGroupPage;
